// Prisma Schema for Szukaj Książek
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  avatarUrl     String?   @map("avatar_url")
  isActive      Boolean   @default(true) @map("is_active")
  isVerified    Boolean   @default(false) @map("is_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  refreshTokens  RefreshToken[]
  userBooks      UserBook[]
  userBookViews  UserBookView[]
  conversations  Conversation[]
  purchases      Purchase[]
  preferences    UserPreferences?

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model UserPreferences {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  favoriteGenres   Json     @default("[]") @map("favorite_genres")
  favoriteAuthors  Json     @default("[]") @map("favorite_authors")
  preferredFormats Json     @default("[\"paper\", \"ebook\", \"audiobook\"]") @map("preferred_formats")
  inferredGenres   Json     @default("{}") @map("inferred_genres")
  inferredAuthors  Json     @default("{}") @map("inferred_authors")
  language         String   @default("pl")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ============================================
// Book Catalog
// ============================================

model Author {
  id        String   @id @default(uuid())
  name      String
  bio       String?
  imageUrl  String?  @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  books BookAuthor[]

  @@index([name])
  @@map("authors")
}

model Category {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  description  String?
  parentId     String?  @map("parent_id")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  parent   Category?      @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[]     @relation("CategoryHierarchy")
  books    BookCategory[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Book {
  id            String    @id @default(uuid())
  isbn          String?   @unique
  ean           String?
  title         String
  originalTitle String?   @map("original_title")
  description   String?
  coverUrl      String?   @map("cover_url")
  publishedAt   DateTime? @map("published_at")
  publisher     String?
  pageCount     Int?      @map("page_count")
  language      String    @default("pl")

  // Format availability
  hasPaper     Boolean @default(false) @map("has_paper")
  hasEbook     Boolean @default(false) @map("has_ebook")
  hasAudiobook Boolean @default(false) @map("has_audiobook")

  // Aggregated ratings
  avgRating    Decimal @default(0) @map("avg_rating") @db.Decimal(3, 2)
  ratingsCount Int     @default(0) @map("ratings_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  authors    BookAuthor[]
  categories BookCategory[]
  userBooks  UserBook[]
  views      UserBookView[]
  offers     Offer[]
  purchases  Purchase[]

  @@index([isbn])
  @@index([ean])
  @@index([title])
  @@map("books")
}

model BookAuthor {
  bookId       String @map("book_id")
  authorId     String @map("author_id")
  role         String @default("author")
  displayOrder Int    @default(0) @map("display_order")

  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  author Author @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@id([bookId, authorId])
  @@index([authorId])
  @@map("book_authors")
}

model BookCategory {
  bookId     String @map("book_id")
  categoryId String @map("category_id")

  book     Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([bookId, categoryId])
  @@index([categoryId])
  @@map("book_categories")
}

// ============================================
// User Interactions
// ============================================

enum ReadingStatus {
  WANT_TO_READ
  READING
  READ
}

model UserBook {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  bookId          String        @map("book_id")
  status          ReadingStatus
  rating          Int?          // 1-5, only allowed when status = READ (enforced in service)
  review          String?
  startedAt       DateTime?     @map("started_at")
  finishedAt      DateTime?     @map("finished_at")
  statusChangedAt DateTime?     @map("status_changed_at") // When status last changed
  ratedAt         DateTime?     @map("rated_at")          // When rating was set/changed
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@index([ratedAt])
  @@map("user_books")
}

model UserBookView {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  bookId       String   @map("book_id")
  viewDuration Int?     @map("view_duration")
  source       String?
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookId])
  @@index([createdAt])
  @@map("user_book_views")
}

// ============================================
// Chat & Conversations
// ============================================

model Conversation {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@map("conversations")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model Message {
  id             String      @id @default(uuid())
  conversationId String      @map("conversation_id")
  role           MessageRole
  content        String
  metadata       Json        @default("{}")
  tokensUsed     Int?        @map("tokens_used")
  createdAt      DateTime    @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================
// Offers & Purchases
// ============================================

enum BookFormat {
  PAPER
  EBOOK
  AUDIOBOOK
}

model Offer {
  id            String     @id @default(uuid())
  bookId        String     @map("book_id")
  buyboxId      String?    @map("buybox_id")
  storeName     String     @map("store_name")
  storeLogoUrl  String?    @map("store_logo_url")
  format        BookFormat
  price         Decimal    @db.Decimal(10, 2)
  currency      String     @default("PLN")
  originalPrice Decimal?   @map("original_price") @db.Decimal(10, 2)
  url           String
  isAvailable   Boolean    @default(true) @map("is_available")
  fetchedAt     DateTime   @default(now()) @map("fetched_at")
  expiresAt     DateTime?  @map("expires_at")

  book      Book       @relation(fields: [bookId], references: [id], onDelete: Cascade)
  purchases Purchase[]

  @@index([bookId])
  @@index([format])
  @@map("offers")
}

model Purchase {
  id            String      @id @default(uuid())
  userId        String      @map("user_id")
  bookId        String?     @map("book_id")
  offerId       String?     @map("offer_id")
  buyboxOrderId String?     @map("buybox_order_id")
  storeName     String?     @map("store_name")
  format        BookFormat?
  price         Decimal?    @db.Decimal(10, 2)
  currency      String      @default("PLN")
  purchasedAt   DateTime?   @map("purchased_at")
  syncedAt      DateTime    @default(now()) @map("synced_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  book  Book?  @relation(fields: [bookId], references: [id])
  offer Offer? @relation(fields: [offerId], references: [id])

  @@index([userId])
  @@index([bookId])
  @@index([purchasedAt])
  @@map("purchases")
}
